<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ¢ãƒ•é€²åŒ–DX -Alive-</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@900&display=swap');
        :root { --main: #5d4037; --sub: #efebe9; --acc: #ffab91; --win: #fff; }
        body { margin: 0; height: 100vh; overflow: hidden; background: #fff8e1; font-family: 'Zen Maru Gothic', sans-serif; touch-action: none; user-select: none; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .ui-layer { position: fixed; inset: 0; pointer-events: none; z-index: 1000; }
        .status-box { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 12px; border-radius: 20px; border: 3px solid var(--sub); pointer-events: auto; width: 160px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .bar-row { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 5px; font-weight: 900; }
        .bar-bg { flex: 1; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* ãƒ¢ãƒ•æœ¬ä½“ï¼ˆç‰©ç†ãƒ™ãƒ¼ã‚¹ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
        #mofu-stage { position: absolute; inset: 0; overflow: hidden; }
        #mofu-container { 
            position: absolute; 
            width: 160px; height: 160px; 
            left: 50%; top: 50%; 
            transform: translate(-50%, -50%);
            cursor: grab;
            z-index: 50;
        }
        .mofu-body { 
            width: 100%; height: 100%; 
            background: #fff; 
            border-radius: 50% 50% 45% 45%; 
            border: 6px solid var(--sub); 
            position: relative; 
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            transition: transform 0.1s ease-out;
        }
        /* å‘¼å¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .breathing { animation: breath 3s ease-in-out infinite; }
        @keyframes breath {
            0%, 100% { transform: scale(1, 1); }
            50% { transform: scale(1.05, 0.95); }
        }
        
        .face { font-size: 50px; pointer-events: none; transition: 0.2s; }
        .equip-item { position: absolute; font-size: 55px; pointer-events: none; z-index: 60; }

        /* ãªã§ãªã§ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .heart { position: absolute; pointer-events: none; animation: heartFloat 1s forwards; font-size: 30px; }
        @keyframes heartFloat {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -150px) scale(1.5); opacity: 0; }
        }

        /* ãŠé¢¨å‘‚ãƒ»ç¡çœ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        #fx-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 400; }
        .dark-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 350; }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .menu { position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; z-index: 2000; }
        .btn { padding: 12px 20px; border-radius: 20px; border: none; background: white; border-bottom: 5px solid #ddd; font-weight: 900; cursor: pointer; transition: 0.1s; }
        .btn:active { transform: translateY(3px); border-bottom-width: 2px; }

        /* ã‚·ãƒ¼ãƒˆ */
        .sheet { position: fixed; bottom: -110%; left: 0; width: 100%; height: 85%; background: white; border-radius: 30px 30px 0 0; z-index: 3000; transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.1); padding: 25px; box-sizing: border-box; overflow-y: auto; }
        .sheet.open { bottom: 0; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        
        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .pop { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.8); background: white; padding: 25px; border-radius: 25px; border: 4px solid var(--main); z-index: 6000; opacity: 0; pointer-events: none; transition: 0.3s; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.2); }
        .pop.show { opacity: 1; transform: translate(-50%,-50%) scale(1); pointer-events: auto; }
    </style>
</head>
<body>

<div id="start-screen" style="position:fixed; inset:0; background:#fff8e1; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <h1>âœ¨ ãƒ¢ãƒ•é€²åŒ–DX âœ¨</h1>
    <input id="in-un" placeholder="ãã¿ã®åå‰" style="padding:15px; border-radius:15px; border:3px solid #ddd; width:70%; margin:10px; font-weight:bold; text-align:center;">
    <input id="in-pn" placeholder="ãƒ¢ãƒ•ã®åå‰" style="padding:15px; border-radius:15px; border:3px solid #ddd; width:70%; margin:10px; font-weight:bold; text-align:center;">
    <button class="btn" style="background:var(--acc); color:white; width:200px;" onclick="initGame()">ã¯ã˜ã‚ã‚‹ï¼</button>
</div>

<div class="ui-layer">
    <div class="status-box">
        <div class="bar-row">ğŸ’–<div class="bar-bg"><div id="b-kizuna" class="bar-fill" style="background:#ff4081;"></div></div></div>
        <div class="bar-row">ğŸ™<div class="bar-bg"><div id="b-food" class="bar-fill" style="background:#ffa000;"></div></div></div>
        <div class="bar-row">ğŸ›<div class="bar-bg"><div id="b-clean" class="bar-fill" style="background:#00bcd4;"></div></div></div>
        <div class="bar-row">ğŸ’¤<div class="bar-bg"><div id="b-hp" class="bar-fill" style="background:#9c27b0;"></div></div></div>
        <div style="margin-top:10px; font-weight:900; color:#f57c00;">ğŸ’° <span id="v-coin">0</span> G</div>
    </div>
</div>

<div id="mofu-stage">
    <div id="mofu-container" class="breathing">
        <div class="mofu-body" id="mofu-main">
            <div id="face" class="face">ãƒ»â©Šãƒ»</div>
            <div id="eq-head" class="equip-item"></div>
            <div id="eq-face" class="equip-item"></div>
            <div id="eq-handR" class="equip-item"></div>
            <div id="eq-handL" class="equip-item"></div>
        </div>
        <div id="mofu-name" style="position:absolute; bottom:-35px; left:50%; transform:translateX(-50%); background:white; padding:2px 12px; border-radius:10px; border:2px solid #ddd; font-weight:bold; white-space:nowrap;"></div>
    </div>
</div>

<canvas id="fx-canvas"></canvas>
<div id="dark-mask" class="dark-mask"></div>

<div class="menu">
    <button class="btn" onclick="openSheet('care')">ğŸ–ï¸ ãŠä¸–è©±</button>
    <button class="btn" onclick="openSheet('work')">âš’ï¸ ãƒã‚¤ãƒˆ</button>
    <button class="btn" onclick="openSheet('shop')">ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—</button>
    <button class="btn" onclick="openSheet('equip')">ğŸ’ è£…å‚™</button>
    <button class="btn" onclick="resetGame()" style="background:#ffccbc;">ğŸ”„</button>
</div>

<div id="sheet-care" class="sheet"><h3>ğŸ–ï¸ ãŠä¸–è©±</h3><hr><div id="list-care" class="grid"></div><button class="btn" onclick="closeSheet()" style="width:100%; margin-top:20px;">ã¨ã˜ã‚‹</button></div>
<div id="sheet-work" class="sheet"><h3>âš’ï¸ ãƒã‚¤ãƒˆ</h3><hr><div id="list-work" class="grid"></div><button class="btn" onclick="closeSheet()" style="width:100%; margin-top:20px;">ã¨ã˜ã‚‹</button></div>
<div id="sheet-shop" class="sheet"><h3>ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—</h3><hr><div id="list-shop" class="grid"></div><button class="btn" onclick="closeSheet()" style="width:100%; margin-top:20px;">ã¨ã˜ã‚‹</button></div>
<div id="sheet-equip" class="sheet"><h3>ğŸ’ è£…å‚™</h3><p>çŸ¢å°ã§ä½ç½®èª¿æ•´ï¼</p><div id="pos-ctrl" style="text-align:center; display:none; margin-bottom:15px;"><span id="cur-slot"></span><br><button class="btn" onclick="moveEq(0,-5)">â¬†</button><br><button class="btn" onclick="moveEq(-5,0)">â¬…</button><button class="btn" onclick="moveEq(5,0)">â¡</button><br><button class="btn" onclick="moveEq(0,5)">â¬‡</button></div><hr><div id="list-equip" class="grid"></div><button class="btn" onclick="closeSheet()" style="width:100%; margin-top:20px;">ã¨ã˜ã‚‹</button></div>

<div id="pop" class="pop"><h3 id="pop-t"></h3><p id="pop-m"></p><button class="btn" onclick="hidePop()">OK</button></div>

<script>
    let d = JSON.parse(localStorage.getItem('mofu_alive')) || {
        un:"", pn:"", cn:100, lvl:1, exp:0,
        kizuna:50, food:50, clean:50, hp:100,
        items:[], eq:{head:"", face:"", handR:"", handL:""},
        pos:{head:{x:0,y:-45}, face:{x:0,y:10}, handR:{x:50,y:50}, handL:{x:-50,y:50}}
    };

    let isSleeping = false, isBathing = false, petCount = 0, lastX = 0, lastY = 0, editingSlot = "";

    // --- åˆæœŸåŒ– ---
    window.onload = () => { if(d.un) startGame(); else document.getElementById('start-screen').style.display='flex'; };

    function initGame() {
        d.un = document.getElementById('in-un').value || "ã„ã£ãã‚“";
        d.pn = document.getElementById('in-pn').value || "ãƒ¢ãƒ•";
        document.getElementById('start-screen').style.display='none';
        startGame();
    }

    function startGame() {
        document.getElementById('mofu-name').innerText = d.pn;
        updateUI();
        autoWalk();
        initPetting();
        requestAnimationFrame(animLoop);
    }

    // --- æœ¬ç‰©ã®ã€Œãªã§ãªã§ã€ã‚·ã‚¹ãƒ†ãƒ  ---
    function initPetting() {
        const m = document.getElementById('mofu-main');
        const handlePet = (e) => {
            if(isSleeping || isBathing) return;
            const x = e.touches ? e.touches[0].clientX : e.clientX;
            const y = e.touches ? e.touches[0].clientY : e.clientY;
            
            // ç§»å‹•è·é›¢ãŒä¸€å®šä»¥ä¸Šãªã‚‰ã€Œãªã§ãŸã€ã¨åˆ¤å®š
            const dist = Math.hypot(x - lastX, y - lastY);
            if(dist > 10) {
                petCount++;
                if(petCount % 5 === 0) {
                    d.kizuna = Math.min(100, d.kizuna + 1);
                    d.exp += 2;
                    spawnHeart(x, y);
                    updateUI();
                }
                m.style.transform = `scale(${1 + Math.min(petCount/200, 0.2)})`;
            }
            lastX = x; lastY = y;
        };
        m.addEventListener('mousemove', handlePet);
        m.addEventListener('touchmove', handlePet);
        const resetPet = () => { petCount = 0; m.style.transform = 'scale(1)'; };
        m.addEventListener('mouseup', resetPet);
        m.addEventListener('touchend', resetPet);
        m.addEventListener('mouseleave', resetPet);
    }

    function spawnHeart(x, y) {
        const h = document.createElement('div');
        h.className = 'heart'; h.innerText = "â¤ï¸";
        h.style.left = x + 'px'; h.style.top = y + 'px';
        document.body.appendChild(h);
        setTimeout(() => h.remove(), 1000);
    }

    // --- ãƒŒãƒ«ãƒŒãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ---
    function animLoop() {
        if(!isSleeping && !isBathing) {
            // ãƒ¢ãƒ•ã‚’å¸¸ã«å°‘ã—æµ®éŠã•ã›ã‚‹
            const time = Date.now() * 0.002;
            const offset = Math.sin(time) * 5;
            // ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã®å¾®èª¿æ•´ã¯ã—ãªã„ï¼ˆautoWalkã¨å¹²æ¸‰ã™ã‚‹ãŸã‚ï¼‰
        }
        requestAnimationFrame(animLoop);
    }

    function autoWalk() {
        setInterval(() => {
            if(isSleeping || isBathing) return;
            const c = document.getElementById('mofu-container');
            const targetX = Math.random() * (window.innerWidth - 200) + 100;
            const targetY = Math.random() * (window.innerHeight - 300) + 150;
            c.style.transition = 'all 3s ease-in-out';
            c.style.left = targetX + 'px';
            c.style.top = targetY + 'px';
        }, 5000);
    }

    // --- ãŠä¸–è©±æ¼”å‡º ---
    function doCare(type) {
        closeSheet();
        if(type === 'bath') {
            isBathing = true;
            const m = document.getElementById('mofu-main');
            m.style.filter = 'blur(2px)';
            startFX('bubble');
            setTimeout(() => { isBathing = false; m.style.filter = ''; d.clean = 100; updateUI(); }, 4000);
        } else if(type === 'sleep') {
            isSleeping = true;
            document.getElementById('dark-mask').style.display = 'block';
            document.getElementById('mofu-container').classList.add('anim-sleep');
            setTimeout(() => { isSleeping = false; document.getElementById('dark-mask').style.display = 'none'; d.hp = 100; updateUI(); }, 5000);
        } else {
            d[type] = Math.min(100, d[type] + 30);
            updateUI();
        }
    }

    function startFX(mode) {
        const canvas = document.getElementById('fx-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];
        for(let i=0; i<30; i++) particles.push({x:Math.random()*canvas.width, y:canvas.height+50, r:Math.random()*20+5, v:Math.random()*2+1});
        
        const draw = () => {
            if(!isBathing) return ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = "rgba(255,255,255,0.7)";
            particles.forEach(p => {
                ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
                p.y -= p.v; if(p.y < -50) p.y = canvas.height+50;
            });
            requestAnimationFrame(draw);
        };
        draw();
    }

    // --- ã‚·ã‚¹ãƒ†ãƒ  ---
    function updateUI() {
        ['kizuna','food','clean','hp'].forEach(k => document.getElementById('b-'+k).style.width = d[k]+'%');
        document.getElementById('v-coin').innerText = d.cn;
        for(let s in d.eq) {
            const el = document.getElementById('eq-'+s);
            el.innerText = d.eq[s];
            el.style.left = '50%'; el.style.top = '50%';
            el.style.transform = `translate(calc(-50% + ${d.pos[s].x}px), calc(-50% + ${d.pos[s].y}px))`;
        }
        const f = document.getElementById('face');
        if(isSleeping) f.innerText = "ï¼â©Šï¼";
        else if(d.kizuna > 80) f.innerText = "ï¼¾â©Šï¼¾";
        else if(d.food < 20) f.innerText = "ğŸ˜µ";
        else f.innerText = "ãƒ»â©Šãƒ»";
        localStorage.setItem('mofu_alive', JSON.stringify(d));
    }

    function openSheet(id) {
        document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open'));
        document.getElementById('sheet-'+id).classList.add('open');
        refreshLists();
    }
    function closeSheet() { document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open')); }

    function refreshLists() {
        const cl = document.getElementById('list-care'); cl.innerHTML="";
        [{n:"ğŸ™ã”ã¯ã‚“",t:"food"},{n:"ğŸš¿ãŠé¢¨å‘‚",t:"bath"},{n:"ğŸ’¤å¯ã‚‹",t:"sleep"}].forEach(i=>{
            const b = document.createElement('button'); b.className='btn'; b.innerText=i.n;
            b.onclick = () => doCare(i.t); cl.appendChild(b);
        });

        const sl = document.getElementById('list-shop'); sl.innerHTML="";
        const items = [
            {n:"ğŸ‘‘ç‹å† ",p:500,s:"head",v:"ğŸ‘‘"},{n:"ğŸ•¶ã‚°ãƒ©ã‚µãƒ³",p:300,s:"face",v:"ğŸ•¶"},
            {n:"ğŸ—¡å‰£",p:800,s:"handR",v:"ğŸ—¡"},{n:"ğŸ›¡ç›¾",p:600,s:"handL",v:"ğŸ›¡"}
        ];
        items.forEach(i=>{
            const b = document.createElement('button'); b.className='btn'; b.innerHTML=`${i.n}<br>ğŸ’°${i.p}`;
            b.onclick = () => { if(d.cn>=i.p){ d.cn-=i.p; d.items.push(i); updateUI(); refreshLists(); } };
            sl.appendChild(b);
        });

        const el = document.getElementById('list-equip'); el.innerHTML="";
        d.items.forEach(i=>{
            const b = document.createElement('button'); b.className='btn'; b.innerText=i.n;
            b.onclick = () => { d.eq[i.s] = i.v; editingSlot = i.s; document.getElementById('pos-ctrl').style.display='block'; updateUI(); };
            el.appendChild(b);
        });

        const wl = document.getElementById('list-work'); wl.innerHTML="";
        [{n:"ğŸ§¹æƒé™¤",r:50},{n:"ğŸ“¦é‹é€",r:200}].forEach(w=>{
            const b = document.createElement('button'); b.className='btn'; b.innerHTML=`${w.n}<br>ğŸ’°${w.r}`;
            b.onclick = () => { d.cn += w.r; d.hp = Math.max(0, d.hp-20); showPop("ãŠç–²ã‚Œï¼",w.r+"Gã‚‚ã‚‰ã£ãŸï¼"); updateUI(); };
            wl.appendChild(b);
        });
    }

    function moveEq(x, y) { if(editingSlot) { d.pos[editingSlot].x += x; d.pos[editingSlot].y += y; updateUI(); } }
    function showPop(t,m) { document.getElementById('pop-t').innerText=t; document.getElementById('pop-m').innerText=m; document.getElementById('pop').classList.add('show'); }
    function hidePop() { document.getElementById('pop').classList.remove('show'); }
    function resetGame() { if(confirm("æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
